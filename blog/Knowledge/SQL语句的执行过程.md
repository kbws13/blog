---
id: the-execution-process-of-SQL-statements
slug: /the-execution-process-of-SQL-statements
title: SQL语句的执行过程
date: 2024-05-15
tags: [SQL, 查询缓存, 语法分析, 词法分析, 优化器, 执行器]
keywords: [SQL, 查询缓存, 语法分析, 词法分析, 优化器, 执行器]
---

以一条查询 SQL 为例：

```sql
select * from user where id=1;
```

在这条查询语句中，大体可以分为两个层面，Server 层和存储引擎层

**Server 层**：涉及到一系列的业务的组件，下面会详细描述各个组件的功能

**存储引擎层**：负责存储发送过来的数据，提供写接口等功能

> MySQL 的存储引擎是插件式的，一个数据库中的不同表可以用不同的存储引擎

具体流程如下：

1）当客户端的 SQL 发送到 MySQL 时，首先是到达 Server 层的连接器，连接器会对你此次发起的连接进行权限校验，以此来获取你这个账号拥有的权限。当你的账号或密码不正确时，会报`Access denied for user`错误。连接成功后如果没有任何操作，那么这个连接就处于空闲状态，到达一定时间后它便会断开连接，这个时间一般是 8 小时，是由 wait_timeout 参数控制的

2）查询缓存，具体就是将一个查询语句作为 key，将上一次请求的结果作为 value，存储在缓存组件中，当同样的语句来查询时即可立刻返回结果，不需要经历词法、语法分析等下面的步骤。只要表有数据改动缓存就失效了，在常见的 联机事务处理（OLTP）场景下是个鸡肋
> 在 MySQL 8.0 之后这个功能去掉了

3）接下来就到分析器来进行语法分析、词法分析。MySQL 首先会对你的语句进行`词法分析`，来判断语句是什么类型以及携带什么参数等。比如：MySQL 会将输入语句的 select 提取出来，判断出这是一条查询语句、将 from 后面的 user 提取出来作为查询的表名、把 id 提取出来作为列名等。做完这些 MySQL 将会进行`语法分析`来判断语句的语法是否有误、是否满足 MySQL 的语法。如果语法有问题，就会报错：`You have an error in your SQL synatx; check the manual...`

4）经过分析器就到了优化器，它会对你的语句进行优化判断。比如你表中有多个索引，优化器会帮你选择使用哪个索引、你使用了 join 多表连接，优化器会帮你调整表的连接顺序。平时使用 explain 其实就是让 MySQL 告诉我们它的优化决定策略是怎么样的

5）最后会到达执行器，它先判断你对这个 user 表是否有权限查询，如果没有权限会拒绝本次查询，返回错误信息。如果有权限，它将会根据表的存储引擎提供的接口进行数据查询，重复遍历表的行数据，判断 id 字段是否等于 1。直到遍历完整个表将符合条件的数据作为结果集返回给客户端

![20240515134653](https://blog-1312417182.cos.ap-chengdu.myqcloud.com/blog/20240515134653.png)
